# Tiedustelua

# z) [Santos et al: [The Art of Hacking]](https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_04_03/)
- Skannaus on hyvä aloittaa pienemmistä ja hiljaisemmista skannauksista, ensin kohteita etsien ja minimaalisilla jäljilla, esim listaskannauksella -sL
- Potentiaalisien kohteiden löytyessä skannauksen äänekkyyttä voidaan siirtyä kyseisten kohteiden porttiskannauksiin

### 4.3 Surveying Essential Tools for Active Recoinnaissance
- NMAP aikalailla paras porttiskanneri, joka tunnistaa mm. myös järstelmiä, palveluita, ja tekee haavoittuvuuskannauksia
- -sS nopea skannaus, lähettää kyselyitä porteille muttei vastaa niihin.
- -T0-5 skannauksen nopeus
- -A sallii järjestelmien tunnistamisen ja version tunnistamisen
    - esim. `sudo nmap -sS -vv -T4 -A 192.168.56.102`
- -Pn käsittelee kaikkia portteja kuin ne olisivat online, joten skannaus ei skippaa vaikkapa tulimuurin blokatessa tietyt portit näkyvistä
- Defaulttina NMAP skannaa default portit, mutta -p voi määrittää mitkä portit, tai vaikka kaikki portit -p-
- 

- Muita skannereita:
    - Masscan (nopein porttiskanneri)
        - esim tietyt portit: `masscan -p80, 443 192.168.56.102/24 --rate=10000`

    - Udpprotoscanner (UDP services)

- EyeWitness
    - Voi tarkistaa useita nettisivuja keräten niistä tietoa, jonka perusteella on helpompi päättää mihin sivuihin kannattaa keskittyä. Esim löytää sadasta sivusta ne, joissa login sivuja, eikä tarvitse manuaalisesti tutkia sivustoja itse
    - `./EyeWitness.py --web -f ip_list.txt`
    - Annetaan EyeWitnessille lista osoitteista, ja se tutkii ne
    - Ottaa sivuista screenshotit ja muuta tietoa, tuloksia voi tutkia raporttisivulla

### 4.4 Network and Web Vulnerability Scanners
- Network vulnerability scanners
    - OpenVAS, NMAP
- Web vulnerabilty scanners
    - Nikto, WPScan, SQLMap, Burp Suite, Zed Attack Proxy

- NMAP vuln scan:
    - Nmap skritpit löytyy [nmapin nettisivuilta](https://nmap.org/nsedoc/)
    - Skriptit voi ladata sivulta ja sijoittaa `/usr/share/nmap/scripts` käytettäväksi
    - sC ajaa defaultin setin scriptejä ja jotkut scripteistä ovat sellaisia, ettei niitä pidä käyttää ilman lupaa

### [Nmap portti skannauksen perusteet](https://nmap.org/book/man-port-scanning-basics.html)
- Nmap jakaa portit kuuteen erilaiseen tilaan, joista tarkastellaan seuraavat
    - Open
        - Ykköskohteita porttiskannauksessa. Applikaatiot avoimissa porteissa ottavat aktiivisesti vastaan TCP yhteyksiä. Jokainen avoin portti on mahdollinen väylä hyökkäykselle. 
    - Closed
        - Suljettu portti on tavoitettavissa, mutta yksikään applikaatio ei kuuntele siellä. Nämä portit antavat viittauksia siitä, että kohde on päällä ja auttaa käyttöjärjstelmän tunnistamisessa. Jatkoa ajatellen niitä on hyvä tarkkailla, sillä käyttäjä saattaa avata ne.
    - Filtered
        - Nmap ei tunnista onko portti auki, koska esim. tulimuuri filtteroi pakettien lähetyksen. Huonompi juttu hyökkääjän näkökulmasta, koska tarjoavat vähän informaatiota ja nmapin lähettäessä uusia pyyntöjä varmistaakseen portin tilan, filtteröity portti hidastaa skannausta.

# Miten [nmap](https://nmap.org/) toimii?
- Tehdään nmapilla seuraavat testit, siepataan liikenne snifferillä ([Wireshark](https://www.wireshark.org/)), ja analysoidaan tulokset. Skannataan vain omia koneita/harjoitusmaaleja, omassa verkossa. Pyritään tekemään testit mahdollisimman minimaalisesti. Harjoitusmaalina toimii metasploitable2.

## a) nmap TCP connect scan -sT
- TCP skannaustyyppi, jota voidaan käyttää ilman raakapakettien käyttöoikeuksia (esim. sudo) tai halutaan tarkistaa IPv6-verkkoja. Nmap pyytää käyttöjärjestelmä muodostamaan yhteyden kohdekoneeseen ja porttiin `connect` kutsulla.
- `sudo nmap -sT -p 80 192.168.56.103`

![-sT scan](/h4-images/sT_scan.png)

- Nopea skannaus ainakin yhdelle portille, joka näyttää sen tilan, oletusservicen ja porttinumeron

## b) nmap TCP SYN "used to be stealth" scan, -sS (tätä käytetään skannatessa useimmin)
- ns. Stealth scan, vaikkei mikään salainen ole
- Ei koskaan saata TCP yhteyksiä loppuun, eli jättää ns kolmivaiheisen kättelyn kesken. Lähettää ensin TCP paketin SYN flägillä, jos portti kohdekoneessa on auki, se vastaa SYN ja ACK flägeillä takaisin ja tässä vaiheessa nmap keskeyttää kättelyn, eli vastaa RST paketilla, joka tarkoittaa "ei mitään, unohda minut". 
- `Yleisin skannausmuoto nopeutensa takia`. Esimerkki nopeudesta, ensin yhden portin skannaus
    - `sudo nmap -sS -p 80 192.168.56.103`

    ![-sS one port scan](/h4-images/sS_scan.png)

    - ja sitten default porteilla
    - `sudo nmap -sS 192.168.56.103`

    ![-sS default scan](/h4-images/sS_all_scan.png)

- Kuten huomataan viimeisen rivin ajasta, skannaus on nopea. Se näyttää avoimet portit ja oletuspalvelut niissä. Lisäksi se näyttää kuinka monta porttia filtteröitiin (default skannaus 1000 yleisintä porttia)

## c) nmap ping sweep -sn
- -sn eli `no port scan` käskee nmappia olla tekemättä porttiskannausta kohteen löytämisen jälkeen ja palauttaa vain löydetyt hostit.
- Voidaan liittää kylkeen esim NSE host skriptejä
- Suhteellisen kevyttä tiedustelua vielä, löydetään ensin kohteet, ennen tarkempia porttiskannailuja
- `sudo nmap -sn 192.168.56.100/24`

![sn_scan](/h4-images/sn_scan.png)

- Palauttaa annetulta ip-osoitteelta listassa kaikki hostit, jotka se löytää.

## d) nmap don't ping -Pn
- Skippaa hostin etsimisen, eli skannaa jokaisen kohde ipn kuin se olisi aktiivinen
- Yleensä aika hidas

## e) nmap version detection -sV (esimerkki yhdestä palvelusta yhdessä portissa riittää)
- Tarkastelee avoimia portteja tunnistaen niiden palveluiden versiot
- `sudo nmap -sV -p80 192.168.56.103`

![-sV scan](/h4-images/sV_scan.png)

- Portin numero, tila ja service näkyy, ja niiden lisäksi tarkempaa tietoa portissa olevasta palvelusta, eli mm. nimi ja versionumero

## f) nmap porttien valinta -p1-100, --top-ports 5, -p-
- `-p1-100` skannaa ensimmäiset 100 porttia
- `-p-` skannaa kaikki portit 
- `--top-ports <n>` skannaa kaikki nmap-services tiedostosta löytyvät 'suosituimmat' portit. Tulokseen voi tällöin tulla myös suljettuja portteja, koska skannaus skannaa vain numeron perusteella ränkätyt portit. n >= 1

- `-p1-100`

![-p1-100 scan](/h4-images/p1-100_scan.png)

- `-p-`

![-p- scan](/h4-images/p-_scan.png)

- `--top-ports 5`

![--top-ports 5 scan](/h4-images/top-ports_scan.png)


## g) nmap ip-osoitteiden valinta; luettelo, verkkomaskilla 10.10.10.0/24, alku- ja loppuosoitteella 10.10.10.100-130 (ipcalc auttaa ymmärtämään, miten verkkomaskia tulkitaan)
- `ipcalc <ip-osoite>` näyttää Netmaskin arvon (kuvassa 24)
- Maski muodostuu seuraavasti (Lähde: [wiki.teltonika-networks.com](https://wiki.teltonika-networks.com/view/What_is_a_Netmask%3F))
![netmask](/h4-images/netmask.png)

- Nmappiin liittyen, maski määrää siis skannattavien ip-osoitteiden määrän. Täysi maski (32) on periaatteessa sama kuin maskia ei laitettaisi skannaukseen ollenkaan, koska se skannaa vain annetun ipn
- Maskilla 24 nmap skannaa kaiken maskin jälkeen, eli periatteessa ip-osoitteen viimeisen pisteen jälkeiset osoitteet 0-255. Mitä pienempi maski, sitä enemmän skannattavaa.
- Esim. 24 maskilla
![24 mask](/h4-images/mask24.png)
- Ja 32 maskilla
![32 mask](/h4-images/mask32.png)

## h) nmap output files -oA foo. Mihin kukin tiedostotyyppi sopii?
- `-oA <tiedostonimi>` tallettaa haun muodoissa nmap, xml, gnmap
- `-oN` tallettaa haun normaalissa muodossa
- `-oX` tallettaa tiedon XML muodossa, jonka hyöty on ilmeisimmin hyvä luettavuus ilman dokumentointia, kunhan siihen tottuu. Dataa voi katsella myös jollain tekstieditorilla.
- `-oG` on hyödyllinen varsinkin jos skannattavia ip-osoitteita on paljon. Se tallettaa jokaisen hostin omalle rivilleen eli on nimensä mukaisesti helposti grepattava
![-oG output](/h4-images/og_output.png)


## j) nmap OS fingerprinting, version detection, scripts, traceroute, -A

## k) nmap ajonaikaiset toiminnot (man nmap: runtime interaction): verbosity v/V, help ?, packet tracing p/P, status s (ja moni muu nappi)

## l) normaalisti 'sudo nmap'. Miten nmap toiminta eroaa, jos sitä ajaa ilman sudoa? Suorita ja analysoi esimerkki.

## m) nmap, vertaile -sV vs -A kestoa (ja lähetetyn datan määrää jos osaat; time, nethogs, wireshark). Käytä harjoitusmaalina metasploitable2.

## d) Ninjojen tapaan. Piiloutuuko nmap-skannaus hyvin palvelimelta? Vinkkejä: Asenna Apache. Aja nmap-versioskannaus -sV omaan paikalliseen weppipalvelimeen. Etsi Apachen lokista tätä koskevat rivit. Wiresharkissa "http" on kätevä filtteri, se tulee siihen yläreunan "Apply a display filter..." -kenttään. Nmap-ajon aikana p laittaa packet tracing päälle. Vapaaehtoinen lisäkohta: jääkö Apachen lokiin jokin todiste nmap-versioskannauksesta?

## UDP-skannaus. "Mulla olis vitsi UDP:sta, mutta en tiedä menisikö se perille":

## e) Mitkä ovat tavallisimmat tai kiinnostavimmat palvelut, joita UDP-skannauksella voisi löytää? (tässä alakohdassa vain vastaus viitteineen, ei tarvita testiä tietokoneella)

## f) Miksi UDP-skannaus on hankalaa ja epäluotettavaa? Miksi UDP-skannauksen kanssa kannattaa käyttää --reason flagia? (tässä alakohdassa vain vastaus viitteineen, ei tarvita testiä tietokoneella)

## g) Vapaaehtoinen bonuskohta: näytä esimerkki onnistuneesta UDP-skannauksesta, sekä jonkin UDP:n erityisominaisuuden takia epäonnistuneesta tai harhaanjohtavan tuloksen antavasta UDP-skannauksesta.

# Aktiivista tiedustelua. Mihin tämä työkalu on tarkoitettu? Kokeile tätä työkalua omaan harjoitusmaaliin ja selitä tulokset:

## h) fuff (hakemistojen kokeilu riittää, vapaaehtoisena bonuksena muutakin)

## i) nikto

# j) Pizza fantasia: jokin valitsemasi tiedustelutyökalu, esimerkiksi EyeWitness, wpscan, openvas tai jokin muu.






# k) Vapaaehtoinen: Tiedustele aktiivisesti jokin HackTheBoxin maalikone. Analysoi tulokset, pääpaino on vastauksessa tulkinnoillasi. Sopivia ovat esimerkiksi EyeWitness, nikto, wpscan, gobuster, openvas ja ffuf. Aputyökaluiksi sopii Linuxin komentokehote, grep, pythonpy... Voit valita näistä vain jonkin tai joitakin työkaluja. Seuraa työkalun toimintaa koko ajan snifferillä, ja käytä vain työkaluja, joiden toiminnan ymmärrät kohtuullisesti. HTB:n ratkaisut yhdessä sovitun salasanan taakse, jotta emme spoilaa toisten kilpailua.

# l) Vapaaehtoinen, haastava: Korkkaa jokin HTB:n kone. Aloita helposta.



- Lähteet
- [Kurssisivu, Tero Karvinen](https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h4-tiedustelua)
- [Santos et al: [The Art of Hacking]](https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_04_03/)
- 