# Tiedustelua

# z) [Santos et al: [The Art of Hacking]](https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_04_03/)
- Skannaus on hyvä aloittaa pienemmistä ja hiljaisemmista skannauksista, ensin kohteita etsien ja minimaalisilla jäljilla, esim listaskannauksella -sL
- Potentiaalisien kohteiden löytyessä skannauksen äänekkyyttä voidaan siirtyä kyseisten kohteiden porttiskannauksiin

### 4.3 Surveying Essential Tools for Active Recoinnaissance
- NMAP aikalailla paras porttiskanneri, joka tunnistaa mm. myös järstelmiä, palveluita, ja tekee haavoittuvuuskannauksia
- -sS nopea skannaus, lähettää kyselyitä porteille muttei vastaa niihin.
- -T0-5 skannauksen nopeus
- -A sallii järjestelmien tunnistamisen ja version tunnistamisen
    - esim. `sudo nmap -sS -vv -T4 -A 192.168.56.102`
- -Pn käsittelee kaikkia portteja kuin ne olisivat online, joten skannaus ei skippaa vaikkapa tulimuurin blokatessa tietyt portit näkyvistä
- Defaulttina NMAP skannaa default portit, mutta -p voi määrittää mitkä portit, tai vaikka kaikki portit -p-
- 

- Muita skannereita:
    - Masscan (nopein porttiskanneri)
        - esim tietyt portit: `masscan -p80, 443 192.168.56.102/24 --rate=10000`

    - Udpprotoscanner (UDP services)

- EyeWitness
    - Voi tarkistaa useita nettisivuja keräten niistä tietoa, jonka perusteella on helpompi päättää mihin sivuihin kannattaa keskittyä. Esim löytää sadasta sivusta ne, joissa login sivuja, eikä tarvitse manuaalisesti tutkia sivustoja itse
    - `./EyeWitness.py --web -f ip_list.txt`
    - Annetaan EyeWitnessille lista osoitteista, ja se tutkii ne
    - Ottaa sivuista screenshotit ja muuta tietoa, tuloksia voi tutkia raporttisivulla

### 4.4 Network and Web Vulnerability Scanners
- Network vulnerability scanners
    - OpenVAS, NMAP
- Web vulnerabilty scanners
    - Nikto, WPScan, SQLMap, Burp Suite, Zed Attack Proxy

- NMAP vuln scan:
    - Nmap skritpit löytyy [nmapin nettisivuilta](https://nmap.org/nsedoc/)
    - Skriptit voi ladata sivulta ja sijoittaa `/usr/share/nmap/scripts` käytettäväksi
    - sC ajaa defaultin setin scriptejä ja jotkut scripteistä ovat sellaisia, ettei niitä pidä käyttää ilman lupaa

### [Nmap portti skannauksen perusteet](https://nmap.org/book/man-port-scanning-basics.html)
- Nmap jakaa portit kuuteen erilaiseen tilaan, joista tarkastellaan seuraavat
    - Open
        - Ykköskohteita porttiskannauksessa. Applikaatiot avoimissa porteissa ottavat aktiivisesti vastaan TCP yhteyksiä. Jokainen avoin portti on mahdollinen väylä hyökkäykselle. 
    - Closed
        - Suljettu portti on tavoitettavissa, mutta yksikään applikaatio ei kuuntele siellä. Nämä portit antavat viittauksia siitä, että kohde on päällä ja auttaa käyttöjärjstelmän tunnistamisessa. Jatkoa ajatellen niitä on hyvä tarkkailla, sillä käyttäjä saattaa avata ne.
    - Filtered
        - Nmap ei tunnista onko portti auki, koska esim. tulimuuri filtteroi pakettien lähetyksen. Huonompi juttu hyökkääjän näkökulmasta, koska tarjoavat vähän informaatiota ja nmapin lähettäessä uusia pyyntöjä varmistaakseen portin tilan, filtteröity portti hidastaa skannausta.

# Miten [nmap](https://nmap.org/) toimii?
- Tehdään nmapilla seuraavat testit, siepataan liikenne snifferillä ([Wireshark](https://www.wireshark.org/)), ja analysoidaan tulokset. Skannataan vain omia koneita/harjoitusmaaleja, omassa verkossa. Pyritään tekemään testit mahdollisimman minimaalisesti. Harjoitusmaalina toimii metasploitable2.

## a) nmap TCP connect scan -sT
- TCP skannaustyyppi, jota voidaan käyttää ilman raakapakettien käyttöoikeuksia (esim. sudo) tai halutaan tarkistaa IPv6-verkkoja. Nmap pyytää käyttöjärjestelmä muodostamaan yhteyden kohdekoneeseen ja porttiin `connect` kutsulla.
- `sudo nmap -sT -p 80 192.168.56.103`

![-sT scan](/h4-images/sT_scan.png)

- Nopea skannaus ainakin yhdelle portille, joka näyttää sen tilan, oletusservicen ja porttinumeron

![wireshark](/h4-images/st_wire.png)

- Ensin lähtee tiedustelu ARPilla oma ip -> kohde ip, kuka siellä on? Kohde ip vastaa ARPilla mac osoitteensa.
- Kolmivaiheinen kättely alkaa, nmap lähettää paketin SYN flägillä, kohdekone vastaa SYN/ACK ja oma kone päättää kättelyn ACK flägillä, mutta lähettää perään vielä RST/ACK paketit, joka resetoi flägit, eli jatkotoimenpiteet yhteyttä varten peruuntuu.

## b) nmap TCP SYN "used to be stealth" scan, -sS (tätä käytetään skannatessa useimmin)
- ns. Stealth scan, vaikkei mikään salainen ole
- Ei koskaan saata TCP yhteyksiä loppuun, eli jättää ns kolmivaiheisen kättelyn kesken. Lähettää ensin TCP paketin SYN flägillä, jos portti kohdekoneessa on auki, se vastaa SYN ja ACK flägeillä takaisin ja tässä vaiheessa nmap keskeyttää kättelyn, eli vastaa RST paketilla, joka tarkoittaa "ei mitään, unohda minut". 
- `Yleisin skannausmuoto nopeutensa takia`. Esimerkki nopeudesta, ensin yhden portin skannaus
    - `sudo nmap -sS -p 80 192.168.56.103`

    ![-sS one port scan](/h4-images/sS_scan.png)
    ![wireshark](/h4-images/ss_1p_wire.png)

    - Kuten edellä tuli mainittua, -sS ei saata kättelyä loppuun, se katkaisee sen kun kohdekone vastaa SYN/ACK.

    - Ajoin `sudo nmap -sS -p20-30 192.168.56.103` nähdäkseni miltä wireshark näyttää useamman portin ajossa, tietäen että tuossa porttihaarukassa on auki ja kiinni olevia portteja

    ![-sS 10 ports](/h4-images/sS_20_scan.png)

    ![wireshark](/h4-images/ss_20p_wire.png)

    - Kuvasta näkee, että avonaiset portit vastaavat SYN/ACK, mutta kiinni oleviksi luokitellut portit vastaavat suoraan RST/ACK, joka on ilmeisesti kiinni olevan portin default vastaus. Oma koneemme ei tähän vastaukseen enää reagoi. 

    - ja sitten default porteilla
    - `sudo nmap -sS 192.168.56.103`

    ![-sS default scan](/h4-images/sS_all_scan.png)

- Kuten huomataan nmap kuvien viimeisen rivin ajasta, skannaus on nopea. Se näyttää avoimet portit ja oletuspalvelut niissä. Lisäksi se näyttää kuinka monta porttia filtteröitiin (default skannaus 1000 yleisintä porttia)

## c) nmap ping sweep -sn
- -sn eli `no port scan` käskee nmappia olla tekemättä porttiskannausta kohteen löytämisen jälkeen ja palauttaa vain löydetyt hostit.
- Voidaan liittää kylkeen esim NSE host skriptejä
- Suhteellisen kevyttä tiedustelua vielä, löydetään ensin kohteet, ennen tarkempia porttiskannailuja
- `sudo nmap -sn 192.168.56.100-105`

![sn_scan](/h4-images/sn_scan.png)

- Palauttaa annetulta ip-osoitteelta listassa kaikki hostit, jotka se löytää.

![wireshark](/h4-images/sn_wire.png)

- Nmappi lähettää ajon ip-osoitteille ARP kyselyn, huutaa onko siellä ketään, ja pyytää vastaamaan kalin ip-osoitteeseen. Mikäli toisessa päässä on joku, se vastaa `ip-osoite is at mac-osoite`. Omaan ip-osoitteeseen ei suoriteta kyselyä, vaikka sekin on nmapin ip-osoitteiden sisällä ja näkyy nmap tuloksissa.

## d) nmap don't ping -Pn
- Skippaa hostin etsimisen, eli skannaa jokaisen kohde ipn kuin se olisi aktiivinen
- Yleensä aika hidas
- Ajoin komennon `sudo nmap -Pn -sn 192.168.56.103-150`, yhdistin siihen -sn, että ajo skippaa porttiskannauksen.

![-Pn scan](/h4-images/Pn_scan.png)

- Tätä tarkastellessa wiresharkissa, se ei palauttanut mitään. Komennosta jos poistaa -sn, wiresharkki alkaa huutaa aikalailla, se lähettää jokaiseen ip-osoitteeseen taas ARP kyselyt ja kun joku vastaa, alkaa porttiskannaus, jossa se lopettaa taas kättelyt kesken. Ja käy muuten paljon portteja läpi, ilmeisesti kaikki 1000 default porttia. Jos koneita olisi useampi päällä 

## e) nmap version detection -sV (esimerkki yhdestä palvelusta yhdessä portissa riittää)
- Tarkastelee avoimia portteja tunnistaen niiden palveluiden versiot
- `sudo nmap -sV -p80 192.168.56.103`

![-sV scan](/h4-images/sV_scan.png)

- Portin numero, tila ja service näkyy, ja niiden lisäksi tarkempaa tietoa portissa olevasta palvelusta, eli mm. nimi ja versionumero

![wireshark](/h4-images/sV_wire.png)

![wireshark](/h4-images/sV_wire2.png)

- Wiresharkissa näkyy nyt ensin porttiskannaus, kuten totuttua, ensimmäisellä kerralla yhteys keskeytetään RST. Sitten yhteys muodostetaan uudestaa tällä kertaa keskeyttämättä. Mustalla pohjalla näkyy muutama rivi liittyen TCP yhteyteen ja sen toimivuuteen, packet losseihin ja pitkiin siirtoaikoihin. 
- Seuraavaksi tapahtuu paljon erilaisia pyyntöjä omasta ip-osoitteesta. Erilaisia HTTP pyyntöjä, POST, GET ja muuta HTTP kamaa. Yhteys lopetetaan (FIN/ACK) ja luodaan uudestaan monta kertaa. 
- Tavaraa tuli wiresharkkiin niin paljon, että kokeilin tutkia jotain toista porttia ja valitsin 21 ftp

![wireshark](/h4-images/sV_wire3.png)

- Yksinkertaisemman näköistä. Porttiskannaus, katkaisu, yhdistäminen onnistuneesti, FTP palvelulta Response, jossa näkyykin versionumero ja yhteyden lopettaminen meidän pyynnöstä. Testasin vielä SHH palvelun porttiin 22 ja oli hyvin samankaltainen tämän FTP esimerkin kanssa, yhteyden muodostamisen jälkeen palvelu vastaa protokollan tiedoilla, jossa yleensä näkyy versiotiedot

![wireshark](/h4-images/sV_wire4.png)

## f) nmap porttien valinta -p1-100, --top-ports 5, -p-
- `-p1-100` skannaa ensimmäiset 100 porttia

![-p1-100 scan](/h4-images/p1-100_scan.png)

- `-p-` skannaa kaikki portit 

![-p- scan](/h4-images/p-_scan.png)

- `--top-ports <n>` skannaa kaikki nmap-services tiedostosta löytyvät 'suosituimmat' portit. Tulokseen voi tällöin tulla myös suljettuja portteja, koska skannaus skannaa vain numeron perusteella ränkätyt portit. n >= 1

![--top-ports 5 scan](/h4-images/top-ports_scan.png)


## g) nmap ip-osoitteiden valinta; luettelo, verkkomaskilla 10.10.10.0/24, alku- ja loppuosoitteella 10.10.10.100-130 (ipcalc auttaa ymmärtämään, miten verkkomaskia tulkitaan)
- `ipcalc <ip-osoite>` näyttää Netmaskin arvon (kuvassa 24)
- Maski muodostuu seuraavasti (Lähde: [wiki.teltonika-networks.com](https://wiki.teltonika-networks.com/view/What_is_a_Netmask%3F))
![netmask](/h4-images/netmask.png)

- Nmappiin liittyen, maski määrää siis skannattavien ip-osoitteiden määrän. Täysi maski (32) on periaatteessa sama kuin maskia ei laitettaisi skannaukseen ollenkaan, koska se skannaa vain annetun ipn
- Maskilla 24 nmap skannaa kaiken maskin jälkeen, eli periatteessa ip-osoitteen viimeisen pisteen jälkeiset osoitteet 0-255. Mitä pienempi maski, sitä enemmän skannattavaa.
- Esim. 24 maskilla

![24 mask](/h4-images/mask24.png)

- Ja 32 maskilla

![32 mask](/h4-images/mask32.png)

## h) nmap output files -oA foo. Mihin kukin tiedostotyyppi sopii?
- `-oA <tiedostonimi>` tallettaa haun muodoissa nmap, xml, gnmap
- `-oN` tallettaa haun normaalissa muodossa
- `-oX` tallettaa tiedon XML muodossa, jonka hyöty on ilmeisimmin hyvä luettavuus ilman dokumentointia, kunhan siihen tottuu. Dataa voi katsella myös jollain tekstieditorilla.
- `-oG` on hyödyllinen varsinkin jos skannattavia ip-osoitteita on paljon. Se tallettaa jokaisen hostin omalle rivilleen eli on nimensä mukaisesti helposti grepattava

![-oG output](/h4-images/og_output.png)


## j) nmap OS fingerprinting, version detection, scripts, traceroute, -A
- `-A` sallii järjestelmän tunnistamisen, versiontunnistuksen, script-skannauksen ja tracerouten
- Näyttää paljon lisätietoa porteissa olevista palveluista
    - Esimerkissä yhdelle portille tehty skannaus

![-A scan](/h4-images/A_scan.png)

![wireshark](/h4-images/A_wire.png)

- Wiresharkissä näkyy että porttiskannaus alkaa kuten aiemminkin, ja myöhemmin tapahtuu paljon lisää pyyntöjä meidän päästä. SSHv1 tai SSHv2 protokollalla lähtee erilaisia scriptskannauksia, jotka hakevat mm ssh-hostkeyt.
- Käyttöjärjestelmän tunnistamiseen liittyviä tapahtumia en osannut löytää erikseen, mutta joissain vastauksissa SSH palvelimeen liittyen mainitaan debian-ubuntu, eli tunnistaisiko skriptit todennäköisen käyttöjärjestelmän palveluiden kautta.

## k) nmap ajonaikaiset toiminnot (man nmap: runtime interaction): verbosity v/V, help ?, packet tracing p/P, status s (ja moni muu nappi)
- ? avaa helpin, jossa seuraavat komennot näkyvät
    - p sallii pakettien seuraamisen, tavaraa nmapin tapahtumista tulee terminaaliin ja paljon. P lopettaa pakettien seuraamisen.
    - v lisää skannauksen verbositeettiä ja V laskee sitä. Verbosity tarkoittaa printattavan tavaran määrää. Suurimmillaan (4) skannaus printtaa jo kaikennäköstä kamaa hexadesimaaleinakin.
    - d kasvattaa debuggauksen tasoa ja D laskee sitä, vaikuttaa taas paljon siihen, mitä tavaraa näytetään kesken skannauksen, esim mikä scripti ajettiin.

## l) normaalisti 'sudo nmap'. Miten nmap toiminta eroaa, jos sitä ajaa ilman sudoa? Suorita ja analysoi esimerkki.
- sudon avulla voidaan ajaa lähes kaikki komennot, `-sT` on yksi poikkeus, joka voidaan ajaa ilman sudoa. Alla esimerkkejä:

![why sudo](/h4-images/whySudo.png)

## m) nmap, vertaile -sV vs -A kestoa (ja lähetetyn datan määrää jos osaat; time, nethogs, wireshark). Käytä harjoitusmaalina metasploitable2.
- `-A` koko metasploitable2n skannaus kesti 53s ja wireshark näyttää noin 4400 pakettia
- `-sV` skannaus kesti 12.2s ja wiresharkissa näkyy noin 2500 pakettia
- Vertailun vuoksi skannasin vielä yhdistelmällä `-sV -sC` ja sekä tulos, että pakettien määrä ja kesto oli lähes identtinen `-A` skannauksen kanssa

## d) Ninjojen tapaan. Piiloutuuko nmap-skannaus hyvin palvelimelta? Aja nmap-versioskannaus -sV omaan paikalliseen weppipalvelimeen. 
- Tein pythonilla SimpleHTTPServerin

![simpleHTTPServer](/h4-images/simplehttpserver.png)

- Ajoin siihen nmappia ja jälkihän siitä jäi serverin lokiin

![log](/h4-images/log.png)

- Myös wiresharkissa näkyi aikalailla samat setit

![log wire](/h4-images/log_wire.png)


# UDP-skannaus. "Mulla olis vitsi UDP:sta, mutta en tiedä menisikö se perille":

## e) Mitkä ovat tavallisimmat tai kiinnostavimmat palvelut, joita UDP-skannauksella voisi löytää? 
- Yleisimpiä UDP portteja ([Examcollection.com](https://www.examcollection.com/certification-training/network-plus-overview-of-common-tcp-and-udp-default-ports.html), [lifewire.com](https://www.lifewire.com/popular-tcp-and-udp-port-numbers-817985))
- DNS (port 53)
- DHCP (port 67, 68)
- POP3 (Post Office Protocol) (port 110)
- Xbox network gaming service (port 88)
- SNMP (161, 162)


## f) Miksi UDP-skannaus on hankalaa ja epäluotettavaa? Miksi UDP-skannauksen kanssa kannattaa käyttää --reason flagia?
- Nmapin UDP skannaus on todella hidas, esimerkissa ajettu vain 20 portille ja sekin kesti useita sekunteja. Otappa siihen 1000 porttia lisää

![udp scan](/h4-images/udp.png)

- `--reason` flägi näyttää porttien tuloksissa minkä tyyppistä pakettia on lähetetty. TCP porteilla todennäköisesti on tässä kohtaa SYN-ACK ([geek-university](https://geek-university.com/nmap/the-reason-flag/))

## g) Vapaaehtoinen bonuskohta: näytä esimerkki onnistuneesta UDP-skannauksesta, sekä jonkin UDP:n erityisominaisuuden takia epäonnistuneesta tai harhaanjohtavan tuloksen antavasta UDP-skannauksesta.
- Tein skannauksen myös [UDP Protocol Scannerilla](https://github.com/CiscoCXSecurity/udp-proto-scanner), joka oli huomattavasti nopeampi, vaikka en määritellyt mitään portteja etukäteen. Skannauksen tuloksesta puolestaan en ymmärtänyt paljon, joitain portteja se hätyytteli enemmän, liekö nämä sitten ollut auki, koska skanneri etsii tiettyjä UDP palveluja.

![UDP Proto Scan](/h4-images/udpprotoscanner.png)

# Aktiivista tiedustelua. Mihin tämä työkalu on tarkoitettu? Kokeile tätä työkalua omaan harjoitusmaaliin ja selitä tulokset:

## h) fuff (hakemistojen kokeilu)
- Latasin ja asensin [ffuf](https://github.com/ffuf/ffuf) githubista sen ohjeiden mukaan
- Aluksi ihmetetytti kun mitään hakemistoja ei löydy, mutta ip-osoitteen eteen täytyikin laittaa metasploitable2n tapauksessa http, ja johan alkoi hakemistoja löytyä
- ffuf näyttää myös hakemistojen koot, sana- ja rivimäärät tällaisella perus hakemistoskannauksella

![ffuf](/h4-images/ffuf.png)


## i) [nikto](https://www.kali.org/tools/nikto/)
- Webpalvelin skanneri, joka palauttaa erilaista tietoa:
    - Tunnistaa haavoittuvuuksia, jotka mahdollistaa esim. brute forcen, XSS/XST hyökkäykset
    - Versiotietoja
    - Löytää hakemistoja ja kertoo mielenkiintoisista lisätietoa

![nikto](/h4-images/nikto.png)

- Skannaustulos kertoo kiinnostavista hakemistoista kuten `/test/`, `/phpMyAdmin/` jonka pitäisi olla salattu tai salasanan takana, `phpinfo()` komento mainittu, joka antaa lisätietoa järjestelmästä.
- Haavoittuvuuksista mainintaa, XSS, Brute force

# j) Pizza fantasia: jokin valitsemasi tiedustelutyökalu, esimerkiksi EyeWitness, wpscan, openvas tai jokin muu.
- [HackTheBox koneen](https://github.com/JesseKar/Pentest-2021-Autumn/blob/main/h4.md#hackthebox-bountyhunter-easy) korkkaamista ajatellen tein EyeWitnessillä tiedustelut sivuille, löytämättä mitään mielenkiintoista työkalun avulla.

![eyewitness 1](/bountyhunter/eyewitness1.png)

![eyewitness 2](/bountyhunter/eyewitness2.png)



# Vapaaehtoinen, haastava: Korkkaa jokin HTB:n kone. Aloita helposta.
## HackTheBox, BountyHunter, Easy
- Aivan ensimmäisenä tutkin miten HackTheBoxin VPN toimii, ja hyvät ohjeet löytyikin heidän omilta sivuiltaan [täältä](https://help.hackthebox.com/en/articles/5185687-gs-introduction-to-lab-access). Ohjeita seuraamalla olin nopeasti muodostanut yhteyden VPN.
    - Mahdollisia ongelmatilanteita varten troubleshooting sivu löytyy [täältä](https://help.hackthebox.com/en/articles/5185536-t-connection-troubleshooting)
- Valitsin Machines listalta helpoksi luokitellun koneen BountyHunter ja liityin koneeseen "Join Machine".

![BountyHunter web](/bountyhunter/bountyhunter.png)

- Varmistan vielä että Kali on VPN verkossa

![ifconfig](/bountyhunter/ifconfig.png)

- Ja pingataan BountyHunterin iptä myös, se vastaa eli homma ok.

- Aloitetaan nmapilla `sudo nmap -sV -sC 10.10.11.100 -oA nmap-20-11-2021-1229`

![nmap](/bountyhunter/nmap.png)

- Maalikoneessa on portissa 22 auki SSH ja OpenSSH 8.2p1 versio, joka on julkaistu 14.2.2020, eli kohta kaksi vuotta vanha versio (Lähde:[OpenSSH](https://www.openssh.com/releasenotes.html)). Nykyinen versio on 8.8, ja välissä tullut 6 uutta versiota koneen versioon nähden.
- Koneessa on portissa 80 auki Apache httpd 2.4.41, joka on julkaistu 14.8.2019, eli yli 2 vuotta sitten. [Apachen](https://httpd.apache.org/security/vulnerabilities_24.html) omilta sivuilta löytyy siihen liittyviä haavoittuvuuksia, joita onkin useampia, mutta ainuttakaan ei ole luokiteltu tärkeäksi.
- Käyttöjärjstelmänä näyttää olevan Linux

- Koska kyseessä on webbipalvelu, käydään kurkkaamassa mitä ip osoitteen takaa löytyy

![web main page](/bountyhunter/bountyhunter_web_main.png)

- Sivu löytyy, joten tässä vaiheessa voisi olla mielenkiintoista tehdä webskannerilla tarkempaa tutkimusta sivustosta, käytetään [Niktoa](https://www.kali.org/tools/nikto/).

- `nikto -o results.html -h 10.10.11.100` skannauksessa tuntui kestävän kauan verrattuna aikasempiin skannauksiin metasploitableen ja earthiin, epäilen onko syy VPNssä

![nikto scan](/bountyhunter/nikto.png)

- Tuloksessa ei oikeastaan pistä silmään muu mielenkiintoinen kuin `/db.php`, käydään kurkkaamassa.
    - Sivulta ei löydy mitään, blank page ilman erroriakaan, joten jätetään tämä toistaiseksi ainakin tähän.

- Koska nikton skanni oli loppupeleissä aika surkean oloinen, ja nikto huomautti jostain headereiden puutteesta, käytetään toista työkalua. Kokeillaan mielenkiinnosta sekä [gobusteria](https://www.kali.org/tools/gobuster/) ja [ffufia](https://github.com/ffuf/ffuf)

![ffuf](/bountyhunter/ffuf.png)

![gobuster](/bountyhunter/gobuster.png)

- Molemmista saadaan samanlaiset tiedot hakemistoista, kävin kurkkaamassa ne läpi ja oikeudet esti kaiken muun paitsi `index.php` (pääsivu) ja `resources`, jonka alta löytyi kiinnosta tiedosto README.txt

![readme.txt](/bountyhunter/readme.png)

- Ilmeisesti `test` käyttäjää ei ole vielä poistettu eikä sen salasanaa ole häshätty. Lisäksi  developer groupin oikeuksissa voi olla jotakin mielenkiintoista ja jokin script tietokantayhteyteen liittyen on kesken. Mietin myös liittyykö `Disable nopass` jotenkin sudo/root oikeuksiin, eli test käyttäjällä olisi ne oikeudet.

- Tuloksissa ei kuitenkaan näkynyt etusivun yläreunan välilehtiä, joista pisti silmään `Portal` alta löytynyt bounty report system - beta, ja testidataa syöttämällä tulee ilmoitus, josta voisi päätellä ettei tietokanta ole vielä pystyssä. Inspectoria ja formia tarkastellessä löytyy funktiot, joilla formi lähettää datan, ja funktiot ovat samat jotka löytyivät `/resources/bountylog.js` hakemistosta. Aiemmin ei kiinnittänyt huomiota, mutta tässä voisi olla jotain tutkittavaa.

![brs-beta](/bountyhunter/beta.png)

- Tässä kohtaa tuli kuitenkin hieman neuvoton olo, että mitähän seuraavaksi, joten päätin kokeilla `test` käyttäjää ssh yhteydessä brute forceamalla [Hydran](https://www.kali.org/tools/hydra/) avulla. Aiempaa kokemusta hydrasta ei ollut ja kokeilin ensin rockyou.txtllä ja huomasin että aikaa näyttäisi kuluvan jotakin +6640 tuntia. Keskeytin haun ja löysin lyhyen salasanalistan, joka ei tuottanut tulosta. Tässä hetkessä ei aikaa jäädä odottelemaan tuntitolkulla brute forcea joten täytyy keksiä jotain muuta.

![failed hydra](/bountyhunter/failed_hydra.png)

- Palataan miettimään webbipalvelua.

- XSSää kokeiltu sivuston eri inputeissa, ei tunnu toimivan eikä post pyynnöst näy URLissa.

- Portal kiinnostaa tällä hetkellä eniten, `readme.txt` mainintojen takia. Mietin josko jollain snifferillä saisi sieltä jotain dataa ulos, kokeillaan [burp suitea](https://www.kali.org/tools/burpsuite/).

- Kaapataan `http://10.10.11.100/log_submit.php` post pyyntö Burpsuitella ja saadaan seuraavanlainen kaappaus

![burp intercept](/bountyhunter/burp_intercept.png)

- Tästä voi päätellä, että data on jollain tavalla kryptattua kun se postataan, ei vaan ole harmainta hajuakaan millä tavalla on kryptattu, joten google laulamaan
- Löysin muutaman työkalun, jolla tarkastaa hashin muoto. Kalissa jo valmiina oleva [hash-indetifier](https://www.kali.org/tools/hash-identifier/), mutta se ei tunnistanut häshiä. Toinen, jotka kokeilin oli [hashid](https://github.com/psypanda/hashID), joka sekään ei tunnistanut häshiä. Epäilin tehneeni jotain väärin kun kumpikaan työkalu ei tunnistanut sitä.
- [Täältä] löysin miten Burpsuiten työkaluja käytetään dekryptaamiseen ja lähetin kaapatun data `Decoderiin`. Edelleen ei ollut hajuakaan missä muodossa hash on, mutta onneksi decoderissa ei ollut montaa vaihtoehtoa.

![burp decoder](/bountyhunter/burpsuite_decoder.png)

- Kokeilin summanmutikassa kaikkia, ja osa heitti punaista ja osa palautti jotakin. Ainoa palautus, jossa oli edes vähän jotain tolkkua oli Base64, ja kävin vielä [CyberCheffissä](https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9_.',true)&input=UEQ5NGJXd2dJSFpsY25OcGIyNDlJakV1TUNJZ1pXNWpiMlJwYm1jOUlrbFRUeTA0T0RVNUxURWlQejRLQ1FrOFluVm5jbVZ3YjNKMFBnb0pDVHgwYVhSc1pUNWhjMlJoWkR3dmRHbDBiR1UlMkJDZ2tKUEdOM1pUNWhjMlJoYzJROEwyTjNaVDRLQ1FrOFkzWnpjejVoYzJSaGN6d3ZZM1p6Y3o0S0NRazhjbVYzWVhKa1BtRnpaR0Z6UEM5eVpYZGhjbVElMkJDZ2tKUEM5aWRXZHlaWEJ2Y25RJTJC) testaamassa, ja dekryptaus näytti samalta, vaikkei siitä mitään nykyisellä tiedolla irti saa.

- Koska tunnuin tässä olevan jumissa, enkä keksinyt keinoja lisää, palasin jatkamaan keskenjääneitä kotitehtäviä. Sieltä hoksasin kokeilla [EyeWitnessiä](https://github.com/FortyNorthSecurity/EyeWitness). Sivujen printit on kohdassa [(j](https://github.com/JesseKar/Pentest-2021-Autumn/blob/main/h4.md#j-pizza-fantasia-jokin-valitsemasi-tiedusteluty%C3%B6kalu-esimerkiksi-eyewitness-wpscan-openvas-tai-jokin-muu), eikä tässä tapauksessa tuntunut auttavan. 

- Jatketaan Burpsuiten kautta miettimistä
- Dekryptattu data on edelleen epäselvää, joten tutkin POST pyyntöä lisää viisastumatta ja kun lähetin sen eteenpäin kunnes sain alla olevan näkymän

![burp decoded](/bountyhunter/burp_decoded.png)

- Oikeassa sivussa näkyy nyt, että payloadi on ensin url decodettu ja Base64 decodettu, ja näyttää ymmärrettävämmältä kuin aiemmin. Tieto mitä tästä saa irti on lähinnä, että tieto lähetetään XML muodossa. XSS aiemmin tutustuteena voisi kiinnostaa onko XML injektioita. -> Googleen.
- OWASPia selailemalla parista eri lähteestä [täältä](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing) ja [täältä](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/07-Testing_for_XML_Injection) löysin tietoa ja esimerkkejä XML injektioista.
- Alkuun oli hankala ymmärtää mitä ja missä kohtaa voin muokata koodia ja alkuun en saanut muuta kuin tyhjää sivua palautettua burpsuiten kaappauksen ja muokkauksen jälkeen.
- Jonkin aikaa räpeltämisen jälkeen onnistuin. Kuvat havainnollistaa tapahtumia

-Ekassa kuvassa kaappasin burpilla siis post pyynnön kuten aiemminkin. Maalaa datan ja right-klikkaamalla `URL`-decodetaan sen ensin. Sitten sama välivaihe paitsi valitaan `Base64` ja decode.

![burp decoding](/bountyhunter/burp_decoding.png)

- Saadaan seuraavaa:

![decoded data](/bountyhunter/decodedData.png)

- Syötetään koodiin XML injektio
    - Taitaa olla kyseessä tarkemmin [XXE](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing) (XML External Entity) injektio, eli luodaan uusi tai muokataan olemassa olevia entityitä ja niiden avulla printataan haluttua 

![xxe passwd](/bountyhunter/xxe_passwd.png)

- Tärkeä steppi ennen lähettämistä tehdä enkoodaus takaisin eli päinvastainen järestys kun aiemmin, elikkä, maalataan taas koko data ja right klikkaamalla Convert selection -> base64 encode -> Convert selection -> URL encode key characters

- Ja lyödään burpista `forwardia` eli lähetetään kaapattu ja muokattu pyyntö

![onnistunut injektio](/bountyhunter/xxe_passwd_web.png)

- Tein saman /etc/shadow kansiolle, mutta se ei jostain syystä onnistunut palauttamaan koskaan mitään. Täytyy lähteä perehtymään miten muuten voin hyödyntää injektioita.







Lähteet
- [Kurssisivu, Tero Karvinen](https://terokarvinen.com/2021/penetration-testing-course-2021-autumn/#h4-tiedustelua)
- [Santos et al: [The Art of Hacking]](https://learning.oreilly.com/videos/the-art-of/9780135767849/9780135767849-SPTT_04_03/)
- [Nmap.org](https://nmap.org/)
- [HackTheBox](https://app.hackthebox.com/home)

